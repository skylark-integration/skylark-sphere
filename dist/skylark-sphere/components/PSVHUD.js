/**
 * skylark-sphere - A version of sphere that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-sphere/
 * @license MIT
 */
define(["skylark-threejs","../_psv/ctoc","../PSVError","../PSVUtils","../PSVMarker","./PSVComponent"],function(e,t,r,i,s,o){"use strict";function n(e){o.call(this,e),this.svgContainer=null,this.markers={},this.currentMarker=null,this.hoveringMarker=null,this.prop={panelOpened:!1,panelOpening:!1,markersButton:this.psv.navbar.getNavbarButton("markers",!0)},this.create()}return n.prototype=Object.create(o.prototype),n.prototype.constructor=n,n.className="psv-hud",n.publicMethods=["addMarker","removeMarker","updateMarker","clearMarkers","getMarker","getCurrentMarker","gotoMarker","hideMarker","showMarker","toggleMarker","toggleMarkersList","showMarkersList","hideMarkersList"],n.prototype.create=function(){o.prototype.create.call(this),this.svgContainer=document.createElementNS(i.svgNS,"svg"),this.svgContainer.setAttribute("class","psv-hud-svg-container"),this.container.appendChild(this.svgContainer),this.container.addEventListener("mouseenter",this,!0),this.container.addEventListener("mouseleave",this,!0),this.container.addEventListener("mousemove",this,!0),this.psv.on("click",this),this.psv.on("dblclick",this),this.psv.on("render",this),this.psv.on("open-panel",this),this.psv.on("close-panel",this)},n.prototype.destroy=function(){this.clearMarkers(!1),this.container.removeEventListener("mouseenter",this),this.container.removeEventListener("mouseleave",this),this.container.removeEventListener("mousemove",this),this.psv.off("click",this),this.psv.off("dblclick",this),this.psv.off("render",this),this.psv.off("open-panel",this),this.psv.off("close-panel",this),delete this.svgContainer,o.prototype.destroy.call(this)},n.prototype.handleEvent=function(e){switch(e.type){case"mouseenter":this._onMouseEnter(e);break;case"mouseleave":this._onMouseLeave(e);break;case"mousemove":this._onMouseMove(e);break;case"click":this._onClick(e.args[0],e,!1);break;case"dblclick":this._onClick(e.args[0],e,!0);break;case"render":this.renderMarkers();break;case"open-panel":this._onPanelOpened();break;case"close-panel":this._onPanelClosed()}},n.prototype.addMarker=function(e,t){if(!e.id)throw new r("missing marker id");if(this.markers[e.id])throw new r('marker "'+e.id+'" already exists');var i=new s(e,this.psv);return i.isNormal()?this.container.appendChild(i.$el):this.svgContainer.appendChild(i.$el),this.markers[i.id]=i,!1!==t&&this.renderMarkers(),i},n.prototype.getMarker=function(e){var t="object"==typeof e?e.id:e;if(!this.markers[t])throw new r('cannot find marker "'+t+'"');return this.markers[t]},n.prototype.getCurrentMarker=function(){return this.currentMarker},n.prototype.updateMarker=function(e,t){var r=this.getMarker(e);return r.update(e),!1!==t&&this.renderMarkers(),r},n.prototype.removeMarker=function(e,t){(e=this.getMarker(e)).isNormal()?this.container.removeChild(e.$el):this.svgContainer.removeChild(e.$el),this.hoveringMarker===e&&this.psv.tooltip.hideTooltip(),e.destroy(),delete this.markers[e.id],!1!==t&&this.renderMarkers()},n.prototype.clearMarkers=function(e){Object.keys(this.markers).forEach(function(e){this.removeMarker(e,!1)},this),!1!==e&&this.renderMarkers()},n.prototype.gotoMarker=function(e,t){return e=this.getMarker(e),this.psv.animate(e,t).then(function(){this.psv.trigger("goto-marker-done",e)}.bind(this))},n.prototype.hideMarker=function(e){this.getMarker(e).visible=!1,this.renderMarkers()},n.prototype.showMarker=function(e){this.getMarker(e).visible=!0,this.renderMarkers()},n.prototype.toggleMarker=function(e){this.getMarker(e).visible^=!0,this.renderMarkers()},n.prototype.toggleMarkersList=function(){this.prop.panelOpened?this.hideMarkersList():this.showMarkersList()},n.prototype.showMarkersList=function(){var e=[];i.forEach(this.markers,function(t){e.push(t)});var t=this.psv.config.templates.markersList({markers:e,config:this.psv.config});this.prop.panelOpening=!0,this.psv.panel.showPanel(t,!0),this.psv.panel.container.querySelector(".psv-markers-list").addEventListener("click",this._onClickItem.bind(this))},n.prototype.hideMarkersList=function(){this.prop.panelOpened&&this.psv.panel.hidePanel()},n.prototype.renderMarkers=function(){if(this.visible){var t=this.psv.isGyroscopeEnabled()?e.Math.radToDeg(this.psv.camera.rotation.z):0;i.forEach(this.markers,function(e){var r=e.visible;if(r&&e.isPoly()){var s=this._getPolyPositions(e);if(r=s.length>(e.isPolygon()?2:1)){e.position2D=this._getPolyDimensions(e,s);var o=s.map(function(e){return e.x+","+e.y}).join(" ");e.$el.setAttributeNS(null,"points",o)}}else if(r){var n=this._getMarkerPosition(e);if(r=this._isMarkerVisible(e,n)){e.position2D=n;var a=e.getScale(this.psv.getZoomLevel());e.isSvg()?e.$el.setAttributeNS(null,"transform","translate("+n.x+", "+n.y+")"+(1!==a?" scale("+a+", "+a+")":"")+(!e.lockRotation&&t?" rotate("+t+")":"")):e.$el.style.transform="translate3D("+n.x+"px, "+n.y+"px, 0px)"+(1!==a?" scale("+a+", "+a+")":"")+(!e.lockRotation&&t?" rotateZ("+t+"deg)":"")}}i.toggleClass(e.$el,"psv-marker--visible",r)}.bind(this))}},n.prototype._isMarkerVisible=function(e,t){return e.position3D.dot(this.psv.prop.direction)>0&&t.x+e.width>=0&&t.x-e.width<=this.psv.prop.size.width&&t.y+e.height>=0&&t.y-e.height<=this.psv.prop.size.height},n.prototype._getMarkerPosition=function(e){if(e._dynamicSize){i.toggleClass(e.$el,"psv-marker--transparent",!0);var t=e.$el.style.transform;e.$el.style.transform=null;var r=e.$el.getBoundingClientRect();e.$el.style.transform=t,i.toggleClass(e.$el,"psv-marker--transparent",!1),e.width=r.right-r.left,e.height=r.bottom-r.top}var s=this.psv.vector3ToViewerCoords(e.position3D);return s.x-=e.width*e.anchor.left,s.y-=e.height*e.anchor.top,s},n.prototype._getPolyPositions=function(e){var t=e.positions3D.length,r=e.positions3D.map(function(e){return{vector:e,visible:e.dot(this.psv.prop.direction)>0}},this),i=[];return r.forEach(function(e,s){e.visible||[0===s?r[t-1]:r[s-1],s===t-1?r[0]:r[s+1]].forEach(function(t){t.visible&&i.push({visible:t,invisible:e,index:s})})}),i.reverse().forEach(function(e){r.splice(e.index,0,{vector:this._getPolyIntermediaryPoint(e.visible.vector,e.invisible.vector),visible:!0})},this),r.filter(function(e){return e.visible}).map(function(e){return this.psv.vector3ToViewerCoords(e.vector)},this)},n.prototype._getPolyIntermediaryPoint=function(r,i){var s=this.psv.prop.direction.clone().normalize(),o=(new e.Vector3).crossVectors(r,i).normalize(),n=(new e.Vector3).crossVectors(o,r).normalize(),a=(new e.Vector3).addVectors(r.clone().multiplyScalar(-s.dot(n)),n.clone().multiplyScalar(s.dot(r))).normalize(),p=(new e.Vector3).crossVectors(a,s);return a.applyAxisAngle(p,.01).multiplyScalar(t.SPHERE_RADIUS)},n.prototype._getPolyDimensions=function(e,t){var r=1/0,i=1/0,s=-1/0,o=-1/0;return t.forEach(function(e){r=Math.min(r,e.x),i=Math.min(i,e.y),s=Math.max(s,e.x),o=Math.max(o,e.y)}),e.width=s-r,e.height=o-i,{x:r,y:i}},n.prototype._onMouseEnter=function(e){var t;e.target&&(t=e.target.psvMarker)&&!t.isPoly()&&(this.hoveringMarker=t,this.psv.trigger("over-marker",t),t.tooltip&&this.psv.tooltip.showTooltip({content:t.tooltip.content,position:t.tooltip.position,left:t.position2D.x,top:t.position2D.y,box:{width:t.width,height:t.height}}))},n.prototype._onMouseLeave=function(e){var t;if(e.target&&(t=e.target.psvMarker)){if(t.isPoly()&&e.relatedTarget&&i.hasParent(e.relatedTarget,this.psv.tooltip.container))return;this.psv.trigger("leave-marker",t),this.hoveringMarker=null,this.psv.tooltip.hideTooltip()}},n.prototype._onMouseMove=function(e){var t;if(!this.psv.prop.moving)if(e.target&&(t=e.target.psvMarker)&&t.isPoly()||e.target&&i.hasParent(e.target,this.psv.tooltip.container)&&(t=this.hoveringMarker)){this.hoveringMarker||(this.psv.trigger("over-marker",t),this.hoveringMarker=t);var r=this.psv.container.getBoundingClientRect();t.tooltip&&this.psv.tooltip.showTooltip({content:t.tooltip.content,position:t.tooltip.position,top:e.clientY-r.top-this.psv.config.tooltip.arrow_size/2,left:e.clientX-r.left-this.psv.config.tooltip.arrow_size,box:{width:2*this.psv.config.tooltip.arrow_size,height:2*this.psv.config.tooltip.arrow_size}})}else this.hoveringMarker&&this.hoveringMarker.isPoly()&&(this.psv.trigger("leave-marker",this.hoveringMarker),this.hoveringMarker=null,this.psv.tooltip.hideTooltip())},n.prototype._onClick=function(e,t,r){var s;e.target&&(s=i.getClosest(e.target,".psv-marker"))&&s.psvMarker?(this.currentMarker=s.psvMarker,this.psv.trigger("select-marker",this.currentMarker,r),this.psv.config.click_event_on_marker?e.marker=s.psvMarker:t.stopImmediatePropagation()):this.currentMarker&&(this.psv.trigger("unselect-marker",this.currentMarker),this.currentMarker=null),s&&s.psvMarker&&s.psvMarker.content?this.psv.panel.showPanel(s.psvMarker.content):this.psv.panel.prop.opened&&(t.stopPropagation(),this.psv.panel.hidePanel())},n.prototype._onClickItem=function(e){var t;if(e.target&&(t=i.getClosest(e.target,"li"))&&t.dataset.psvMarker){var r=this.getMarker(t.dataset.psvMarker);this.psv.trigger("select-marker-list",r),this.gotoMarker(r,1e3),this.psv.panel.hidePanel()}},n.prototype._onPanelOpened=function(){this.prop.panelOpening?(this.prop.panelOpening=!1,this.prop.panelOpened=!0):this.prop.panelOpened=!1,this.prop.markersButton&&this.prop.markersButton.toggleActive(this.prop.panelOpened)},n.prototype._onPanelClosed=function(){this.prop.panelOpened=!1,this.prop.panelOpening=!1,this.prop.markersButton&&this.prop.markersButton.toggleActive(!1)},n});
//# sourceMappingURL=../sourcemaps/components/PSVHUD.js.map
