/**
 * skylark-sphere - A version of sphere that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-sphere/
 * @license MIT
 */
define(["skylark-threejs","./_psv/ctoc","./PSVError","./PSVUtils","./PSVMarker","./PSVAnimation","./_psv/core","./_psv/defaults","./_psv/events","./_psv/utils"],function(t,e,o,i,n,s){"use strict";return e.prototype.load=function(){if(!this.config.panorama)throw new o("No value given for panorama.");return this.setPanorama(this.config.panorama,!1)},e.prototype.getPosition=function(){return{longitude:this.prop.position.longitude,latitude:this.prop.position.latitude}},e.prototype.getZoomLevel=function(){return this.prop.zoom_lvl},e.prototype.getSize=function(){return{width:this.prop.size.width,height:this.prop.size.height}},e.prototype.isAutorotateEnabled=function(){return!!this.prop.autorotate_cb},e.prototype.isGyroscopeEnabled=function(){return!!this.prop.orientation_cb},e.prototype.isStereoEnabled=function(){return!!this.stereoEffect},e.prototype.isFullscreenEnabled=function(){return i.isFullscreenEnabled(this.container)},e.prototype.needsUpdate=function(){this.prop.needsUpdate=!0},e.prototype.render=function(){this._render()},e.prototype.destroy=function(){window.cancelAnimationFrame(this.prop.main_reqid),this._stopAll(),this.stopKeyboardControl(),this.stopNoSleep(),this.exitFullscreen(),this.unlockOrientation(),this._unbindEvents(),this.tooltip&&this.tooltip.destroy(),this.notification&&this.notification.destroy(),this.hud&&this.hud.destroy(),this.loader&&this.loader.destroy(),this.navbar&&this.navbar.destroy(),this.panel&&this.panel.destroy(),this.overlay&&this.overlay.destroy(),this.scene&&i.cleanTHREEScene(this.scene),this.canvas_container&&this.container.removeChild(this.canvas_container),this.parent.removeChild(this.container),delete this.parent.photoSphereViewer,delete this.parent,delete this.container,delete this.loader,delete this.navbar,delete this.hud,delete this.panel,delete this.tooltip,delete this.notification,delete this.overlay,delete this.canvas_container,delete this.renderer,delete this.noSleep,delete this.scene,delete this.camera,delete this.mesh,delete this.raycaster,delete this.passes,delete this.config,this.prop.cache.length=0},e.prototype.setPanorama=function(t,e,i){if(null!==this.prop.loading_promise)throw new o("Loading already in progress");"boolean"==typeof e&&(i=e,e=void 0),e||this.scene?e||(e={}):e={longitude:this.config.default_long,latitude:this.config.default_lat,zoom:this.config.default_zoom_lvl,sphere_correction:this.config.sphere_correction};var n=this.isExtendedPosition(e),s="zoom"in e;(n||s)&&this._stopAll(),this.config.panorama=t;var r=function(){this.loader.hide(),this.canvas_container.style.opacity=1,this.prop.loading_promise=null}.bind(this);return i&&this.config.transition&&this.scene?(this.config.transition.loader&&this.loader.show(),this.prop.loading_promise=this._loadTexture(this.config.panorama).then(function(t){return this.loader.hide(),this._transition(t,e)}.bind(this)).then(r,r)):(this.loader.show(),this.canvas_container&&(this.canvas_container.style.opacity=0),this.prop.loading_promise=this._loadTexture(this.config.panorama).then(function(t){this._setTexture(t),e.sphere_correction&&!this.prop.isCubemap&&this._setSphereCorrection(this.mesh,e.sphere_correction),n&&this.rotate(e),s&&this.zoom(e.zoom)}.bind(this)).then(r,r)),this.prop.loading_promise},e.prototype.startAutorotate=function(){this._stopAll(),this.prop.autorotate_cb=this._getAutorotateUpdate(),this.on("before-render",this.prop.autorotate_cb),this.trigger("autorotate",!0)},e.prototype._getAutorotateUpdate=function(){var t,e;return function(o){e=void 0===t?0:o-t,t=o,this.rotate({longitude:this.prop.position.longitude+this.config.anim_speed*e/1e3,latitude:this.prop.position.latitude-(this.prop.position.latitude-this.config.anim_lat)/200})}},e.prototype.stopAutorotate=function(){this.prop.start_timeout&&(window.clearTimeout(this.prop.start_timeout),this.prop.start_timeout=null),this.isAutorotateEnabled()&&(this.off("before-render",this.prop.autorotate_cb),this.prop.autorotate_cb=null,this.trigger("autorotate",!1))},e.prototype.toggleAutorotate=function(){this.isAutorotateEnabled()?this.stopAutorotate():this.startAutorotate()},e.prototype.startGyroscopeControl=function(){if(i.checkTHREE("DeviceOrientationControls"))return e.SYSTEM.deviceOrientationSupported.then(function(e){if(!e)return console.warn("PhotoSphereViewer: gyroscope not available"),Promise.reject();this._stopAll(),this.doControls=new t.DeviceOrientationControls(this.camera),this.doControls.alphaOffset=this.prop.position.longitude,this.doControls.update();var o=this.camera.getWorldDirection(new t.Vector3),i=this.vector3ToSphericalCoords(o);this.prop.gyro_alpha_offset=i.longitude,this.prop.orientation_cb=this._getOrientationUpdate(),this.on("before-render",this.prop.orientation_cb),this.trigger("gyroscope-updated",!0)}.bind(this));throw new o("Missing Three.js components: DeviceOrientationControls. Get them from three.js-examples package.")},e.prototype._getOrientationUpdate=function(){return function(){this.doControls.alphaOffset=this.prop.gyro_alpha_offset,this.doControls.update(),this.camera.getWorldDirection(this.prop.direction),this.prop.direction.multiplyScalar(e.SPHERE_RADIUS);var t=this.vector3ToSphericalCoords(this.prop.direction);this.prop.position.longitude=t.longitude,this.prop.position.latitude=t.latitude,this.needsUpdate()}},e.prototype.stopGyroscopeControl=function(){this.isGyroscopeEnabled()&&(this.off("before-render",this.prop.orientation_cb),this.prop.orientation_cb=null,this.doControls.disconnect(),this.doControls=null,this.trigger("gyroscope-updated",!1))},e.prototype.toggleGyroscopeControl=function(){this.isGyroscopeEnabled()?this.stopGyroscopeControl():this.startGyroscopeControl()},e.prototype.startNoSleep=function(){"NoSleep"in window?(this.noSleep||(this.noSleep=new NoSleep),this.noSleep.enable()):console.warn("PhotoSphereViewer: NoSleep is not available")},e.prototype.stopNoSleep=function(){this.noSleep&&this.noSleep.disable()},e.prototype.startStereoView=function(){if(!i.checkTHREE("DeviceOrientationControls","StereoEffect"))throw new o("Missing Three.js components: StereoEffect, DeviceOrientationControls. Get them from three.js-examples package.");this.startNoSleep(),this.enterFullscreen(),this.lockOrientation(),this.startGyroscopeControl().then(function(){this.stereoEffect=new t.StereoEffect(this.renderer),this.needsUpdate(),this.hud.hide(),this.navbar.hide(),this.panel.hidePanel(),this.trigger("stereo-updated",!0),this.notification.showNotification({content:this.config.lang.stereo_notification,timeout:3e3})}.bind(this),function(){this.unlockOrientation(),this.exitFullscreen(),this.stopNoSleep()}.bind(this))},e.prototype.stopStereoView=function(){this.isStereoEnabled()&&(this.stereoEffect=null,this.needsUpdate(),this.hud.show(),this.navbar.show(),this.unlockOrientation(),this.exitFullscreen(),this.stopNoSleep(),this.stopGyroscopeControl(),this.trigger("stereo-updated",!1))},e.prototype.lockOrientation=function(){var t,o=function(){this.isStereoEnabled()&&window.innerHeight>window.innerWidth&&this.overlay.showOverlay({image:e.ICONS["mobile-rotate.svg"],text:this.config.lang.please_rotate[0],subtext:this.config.lang.please_rotate[1]}),t&&window.clearTimeout(t)};window.screen&&window.screen.orientation?(window.screen.orientation.lock("landscape").then(null,o.bind(this)),t=setTimeout(o.bind(this),500)):o.apply(this)},e.prototype.unlockOrientation=function(){window.screen&&window.screen.orientation?window.screen.orientation.unlock():this.overlay.hideOverlay()},e.prototype.toggleStereoView=function(){this.isStereoEnabled()?this.stopStereoView():this.startStereoView()},e.prototype.rotate=function(t,e){this.cleanPosition(t),e||this.applyRanges(t).forEach(this.trigger.bind(this,"_side-reached")),this.prop.position.longitude=t.longitude,this.prop.position.latitude=t.latitude,this.needsUpdate(),this.trigger("position-updated",this.getPosition())},e.prototype.animate=function(t,o){this._stopAll();var n,r=this.isExtendedPosition(t),a="zoom"in t,h={};if(r){this.cleanPosition(t),this.applyRanges(t);var p=this.prop.position,l=Math.abs(t.longitude-p.longitude),c=Math.abs(t.latitude-p.latitude);if(l>=e.ANGLE_THRESHOLD||c>=e.ANGLE_THRESHOLD){var d=i.getShortestArc(this.prop.position.longitude,t.longitude);h.longitude={start:p.longitude,end:p.longitude+d},h.latitude={start:p.latitude,end:t.latitude},n=this.speedToDuration(o,i.getAngle(p,t))}}if(a){var u=Math.abs(t.zoom-this.prop.zoom_lvl);u>=1&&(h.zoom={start:this.prop.zoom_lvl,end:t.zoom},n||(n=this.speedToDuration(o,Math.PI/4*u/100)))}return n?(this.prop.animation_promise=new s({properties:h,duration:n,easing:"inOutSine",onTick:function(t){r&&this.rotate(t,!0),a&&this.zoom(t.zoom)}.bind(this)}),this.prop.animation_promise):(r&&this.rotate(t),a&&this.zoom(t.zoom),s.resolve())},e.prototype.stopAnimation=function(){return this.prop.animation_promise?new Promise(function(t){this.prop.animation_promise.finally(t),this.prop.animation_promise.cancel(),this.prop.animation_promise=null}.bind(this)):Promise.resolve()},e.prototype.zoom=function(e){this.prop.zoom_lvl=i.bound(e,0,100),this.prop.vFov=this.config.max_fov+this.prop.zoom_lvl/100*(this.config.min_fov-this.config.max_fov),this.prop.hFov=t.Math.radToDeg(2*Math.atan(Math.tan(t.Math.degToRad(this.prop.vFov)/2)*this.prop.aspect)),this.needsUpdate(),this.trigger("zoom-updated",this.getZoomLevel())},e.prototype.zoomIn=function(){this.prop.zoom_lvl<100&&this.zoom(this.prop.zoom_lvl+this.config.zoom_speed)},e.prototype.zoomOut=function(){this.prop.zoom_lvl>0&&this.zoom(this.prop.zoom_lvl-this.config.zoom_speed)},e.prototype.resize=function(t){t.width&&(this.container.style.width=t.width),t.height&&(this.container.style.height=t.height),this._onResize()},e.prototype.enterFullscreen=function(){i.requestFullscreen(this.container)},e.prototype.exitFullscreen=function(){this.isFullscreenEnabled()&&i.exitFullscreen()},e.prototype.toggleFullscreen=function(){this.isFullscreenEnabled()?this.exitFullscreen():this.enterFullscreen()},e.prototype.startKeyboardControl=function(){window.addEventListener("keydown",this)},e.prototype.stopKeyboardControl=function(){window.removeEventListener("keydown",this)},e.prototype.preloadPanorama=function(t){if(!this.config.cache_texture)throw new o("Cannot preload panorama, cache_texture is disabled");return this._loadTexture(t)},e.prototype.clearPanoramaCache=function(t){if(!this.config.cache_texture)throw new o("Cannot clear cache, cache_texture is disabled");if(t){for(var e=0,i=this.prop.cache.length;e<i;e++)if(this.prop.cache[e].panorama===t){this.prop.cache.splice(e,1);break}}else this.prop.cache.length=0},e.prototype.getPanoramaCache=function(t){if(!this.config.cache_texture)throw new o("Cannot query cache, cache_texture is disabled");return this.prop.cache.filter(function(e){return e.panorama===t}).shift()},e.Error=o,e});
//# sourceMappingURL=sourcemaps/PhotoSphereViewer.js.map
